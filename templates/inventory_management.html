{% extends "base.html" %}

{% block content %}
    <h2 style="margin-top: 10px;">Inventory Management</h2>

    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
        
        <div>
            <h3>Current Calculated Stock (Generic)</h3>
            <div style="background-color: white; padding: 15px; border: 1px solid #ddd; border-radius: 4px; box-shadow: 0 1px 3px rgba(0,0,0,0.05);">
                {% if part_stock_summary %}
                    <div style="max-height: 400px; overflow-y: auto;">
                        <table>
                            <thead>
                                <tr>
                                    <th style="background-color: #777;">Part Number</th>
                                    <th style="background-color: #777;">Quantity</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for part, count in part_stock_summary.items() %}
                                <tr>
                                    <td>{{ part }}</td>
                                    <td style="font-weight: bold; color: {% if count < 5 %}#CC0000{% else %}#4CAF50{% endif %};">{{ count }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <p style="text-align: center; color: #666; padding: 10px;">No stock calculated yet (Log swaps or adjustments).</p>
                {% endif %}
            </div>
        </div>

        <div>
            <h3>Log Manual Stock Adjustment</h3>
            {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                    {% for category, message in messages %}
                        <div class="message-box {% if category == 'error' %}error-box{% else %}success-box{% endif %}">
                            {{ message|safe }}
                        </div>
                    {% endfor %}
                {% endif %}
            {% endwith %}
            <form method="POST">
                
                {# ðŸš€ NEW PART ACRONYM FIELD ADDED HERE #}
                <div style="margin-bottom: 10px;">
                    <label for="part_acronym">Part Acronym</label>
                    <select id="part_acronym" name="part_acronym" required>
                        <option value="">-- Select Part --</option>
                        {% for part in known_parts %}
                            <option value="{{ part }}">{{ part }}</option>
                        {% endfor %}
                    </select>
                    <p style="font-size: 0.8em; color: #666; margin-top: 5px;">Select the generic part stock to adjust.</p>
                </div>
                {# END NEW FIELD #}

                <div style="margin-bottom: 10px;">
                    <label for="part_sku">{{ column_map['part_sku'] }} (Full SKU)</label>
                    <input type="text" id="part_sku" name="part_sku" required list="sku-suggestions">
                    <datalist id="sku-suggestions">
                        {% for sku in all_skus %}
                            <option value="{{ sku }}">
                        {% endfor %}
                    </datalist>
                    <p style="font-size: 0.8em; color: #666; margin-top: -5px;">Example: A01-1234567.</p>
                </div>

                <div style="margin-bottom: 10px;">
                    <label for="bin">Bin Location</label>
                    <input type="text" id="bin" name="bin" required placeholder="e.g., A1-SHELF, QC-HOLD">
                    <p style="font-size: 0.8em; color: #666; margin-top: -5px;">Where the part is physically going.</p>
                </div>

                <div style="margin-bottom: 10px;">
                    <label for="quantity">{{ column_map['quantity'] }} (+ or -)</label>
                    <input type="number" id="quantity" name="quantity" required placeholder="e.g., 5 for addition, -3 for removal">
                </div>
                
                <div style="margin-bottom: 20px;">
                    <label for="notes">{{ column_map['notes'] }}</label>
                    <textarea id="notes" name="notes" rows="2" required></textarea>
                </div>

                <div>
                    <button type="submit" class="button">Log Adjustment</button>
                </div>
            </form>
        </div>
    </div>
    
    <hr style="margin: 30px 0;">

    {# --- NEW SECTION: DETAILED STOCK BY BIN --- #}
    <h3 style="margin-top: 30px;">Detailed Stock by Bin Location</h3>
    {% if stock_detail %}
    <div style="overflow-x: auto; border: 1px solid #ddd; margin-bottom: 30px;">
        <table style="min-width: 800px;">
            <thead>
                <tr style="background-color: #555;">
                    <th style="color: white;">{{ column_map['part_sku'] }}</th>
                    <th style="color: white;">Part Acronym</th>
                    <th style="color: white;">Bin Location</th>
                    <th style="color: white;">Quantity in Bin</th>
                </tr>
            </thead>
            <tbody>
                {% for entry in stock_detail %}
                <tr>
                    <td>{{ entry.part_sku }}</td>
                    <td><strong style="color: #1E90FF;">{{ entry.part_acronym }}</strong></td>
                    <td><strong style="color: #1E90FF;">{{ entry.bin }}</strong></td>
                    <td style="font-weight: bold;">{{ entry.quantity|int }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <p class="message-box" style="margin-top: 15px; background-color: #f0f0f0; border-left: 5px solid #aaa; margin-bottom: 30px;">
        No detailed stock records found (Stock level is zero or less in all bins).
    </p>
    {% endif %}
    {# --- END NEW SECTION --- #}

    <h2 style="margin-top: 30px;">Inventory Adjustment Log History</h2>
    
    {% if log_entries %}
    <div style="overflow-x: auto; border: 1px solid #ddd;">
        <table style="min-width: 800px;">
            <thead>
                <tr>
                    <th>Log ID</th>
                    <th>Date</th>
                    <th>Part Acronym</th> {# NEW COLUMN HEADER #}
                    <th>{{ column_map['part_sku'] }}</th>
                    <th>Bin/Location</th>
                    <th>Change</th>
                    <th>{{ column_map['notes'] }}</th>
                </tr>
            </thead>
            <tbody>
                {% for entry in log_entries %}
                <tr>
                    <td>{{ entry.inventory_id[:8] }}...</td>
                    <td>{{ entry.inventory_date.strftime('%Y-%m-%d %H:%M') }}</td>
                    <td>{{ entry.part_acronym or '-' }}</td> {# NEW COLUMN VALUE #}
                    <td>{{ entry.part_sku }}</td>
                    <td>{{ entry.bin if entry.bin else 'N/A' }}</td>
                    <td style="font-weight: bold; color: {% if entry.quantity|int > 0 %}#4CAF50{% else %}#CC0000{% endif %};">
                        {{ '+' if entry.quantity|int > 0 else '' }}{{ entry.quantity }}
                    </td>
                    <td>{{ entry.notes }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <p class="message-box" style="margin-top: 15px; background-color: #f0f0f0; border-left: 5px solid #aaa;">
        No manual adjustments logged yet.
    </p>
    {% endif %}
{% endblock %}