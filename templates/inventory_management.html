{% extends "base.html" %}

{% block content %}
    <h2 style="margin-top: 10px;">Inventory Management</h2>

    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">

        <div>
            <h3>Current Calculated Stock (Generic)</h3>
            <div style="background-color: white; padding: 15px; border: 1px solid #ddd; border-radius: 4px; box-shadow: 0 1px 3px rgba(0,0,0,0.05);">
                {% if part_stock_summary %}
                    <div style="max-height: 400px; overflow-y: auto;">
                        <table>
                            <thead>
                                <tr>
                                    <th style="background-color: #777;">Part</th>
                                    <th style="background-color: #777;">Quantity</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for part, count in part_stock_summary.items() %}
                                <tr>
                                    <td>{{ part }}</td>
                                    <td style="font-weight: bold; color: {% if count < 5 %}#CC0000{% else %}#4CAF50{% endif %};">{{ count }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <p style="text-align: center; color: #666; padding: 10px;">No stock calculated yet (Log swaps or adjustments).</p>
                {% endif %}
            </div>
        </div>

        <div>
            <h3>Log Manual Stock Adjustment</h3>
            <form method="POST">

                <div style="margin-bottom: 10px;">
                    <label for="part_acronym">Part Acronym</label>
                    <input type="text" id="part_acronym" name="part_acronym" required list="acronym-suggestions" placeholder="Selecciona o Crea uno nuevo!!">
                    <p style="font-size: 0.8em; color: #666; margin-top: 5px;">Select or type a new one. Sin errores verifica!! </p>
                </div>

                <div style="margin-bottom: 10px;">
                    <label for="part_sku">{{ column_map['part_sku'] }} (Full SKU)</label>
                    <input type="text" id="part_sku" name="part_sku" required list="sku-suggestions">
                    <p style="font-size: 0.8em; color: #666; margin-top: -5px;">.</p>
                </div>

                <div style="margin-bottom: 10px;">
                    <label for="bin">Bin Location</label>
                    <input type="text" id="bin" name="bin" required placeholder="Where the part is physically going." list="bin-suggestions">
                </div>

                <div style="margin-bottom: 10px;">
                    <label for="quantity">{{ column_map['quantity'] }} (+ or -)</label>
                    <input type="number" id="quantity" name="quantity" required placeholder="Use negative for removal -1">
                </div>

                <div style="margin-bottom: 20px;">
                    <label for="notes">{{ column_map['notes'] }}</label>
                    <textarea id="notes" name="notes" rows="2" required></textarea>
                </div>

                <div>
                    <button type="submit" class="button">Log Adjustment</button>
                </div>
            </form>
        </div>
    </div>

    <hr style="margin: 30px 0;">

    {# --- DETAILED STOCK BY BIN --- #}
    <h3 style="margin-top: 30px;">Detailed Stock by Bin Location</h3>
    {% if stock_detail %}
    <div style="overflow-x: auto; border: 1px solid #ddd; margin-bottom: 30px;">
        <table style="min-width: 800px;">
            <thead>
                <tr style="background-color: #555;">
                    <th style="color: white;">{{ column_map['part_sku'] }}</th>
                    <th style="color: white;">Part Acronym</th>
                    <th style="color: white;">Bin Location</th>
                    <th style="color: white;">Quantity in Bin</th>
                </tr>
            </thead>
            <tbody>
                {% for entry in stock_detail %}
                <tr>
                    <td>{{ entry.part_sku }}</td>
                    <td><strong style="color: #1E90FF;">{{ entry.part_acronym }}</strong></td>
                    <td><strong style="color: #1E90FF;">{{ entry.bin }}</strong></td>
                    <td style="font-weight: bold;">{{ entry.quantity|int }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <p class="message-box" style="margin-top: 15px; background-color: #f0f0f0; border-left: 5px solid #aaa; margin-bottom: 30px;">
        No detailed stock records found (Stock level is zero or less in all bins).
    </p>
    {% endif %}

    <h2 style="margin-top: 30px;">Inventory Adjustment Log History</h2>

    {% if log_entries %}
    <div style="overflow-x: auto; border: 1px solid #ddd;">
        <table style="min-width: 800px;">
            <thead>
                <tr>
                    <th>Log ID</th>
                    <th>Date</th>
                    <th>Part Acronym</th>
                    <th>{{ column_map['part_sku'] }}</th>
                    <th>Bin/Location</th>
                    <th>Change</th>
                    <th>{{ column_map['notes'] }}</th>
                </tr>
            </thead>
            <tbody>
                {% for entry in log_entries %}
                <tr>
                    <td>{{ entry.inventory_id[:8] }}...</td>
                    {# Corrected date formatting check #}
                    <td>{{ entry.inventory_date.strftime('%Y-%m-%d %H:%M') if entry.inventory_date and entry.inventory_date is not string else entry.inventory_date or '-' }}</td>
                    <td>{{ entry.part_acronym or '-' }}</td>
                    <td>{{ entry.part_sku }}</td>
                    <td>{{ entry.bin if entry.bin else 'N/A' }}</td>
                    <td style="font-weight: bold; color: {% if entry.quantity|int > 0 %}#4CAF50{% else %}#CC0000{% endif %};">
                        {{ '+' if entry.quantity|int > 0 else '' }}{{ entry.quantity }}
                    </td>
                    <td>{{ entry.notes }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    {% if log_pagination %} {# Check if pagination object exists #}
    <div class="pagination">
        {# Previous Page Link #}
        {% if log_pagination.has_prev %}
            <a href="{{ url_for('inventory_management', log_page=log_pagination.prev_num) }}" class="page-link">&laquo; Previous Log Page</a>
        {% else %}
            <span class="page-link disabled">&laquo; Previous Log Page</span>
        {% endif %}

        {# Page Number Links #}
        {% for page_num in log_pagination.iter_pages(left_edge=1, right_edge=1, left_current=1, right_current=2) %}
            {% if page_num %}
                {% if log_pagination.page == page_num %}
                    <span class="page-link current">{{ page_num }}</span>
                {% else %}
                    <a href="{{ url_for('inventory_management', log_page=page_num) }}" class="page-link">{{ page_num }}</a>
                {% endif %}
            {% else %}
                <span class="page-link ellipsis">â€¦</span>
            {% endif %}
        {% endfor %}

        {# Next Page Link #}
        {% if log_pagination.has_next %}
            <a href="{{ url_for('inventory_management', log_page=log_pagination.next_num) }}" class="page-link">Next Log Page &raquo;</a>
        {% else %}
            <span class="page-link disabled">Next Log Page &raquo;</span>
        {% endif %}
         <span class="page-info">Log Page {{ log_pagination.page }} of {{ log_pagination.pages }} ({{ log_pagination.total }} entries)</span>
    </div>
    {% endif %}
    {% else %}
    <p class="message-box" style="margin-top: 15px; background-color: #f0f0f0; border-left: 5px solid #aaa;">
        No inventory log entries found yet.
    </p>
    {% endif %}

    <datalist id="acronym-suggestions">
        {% for part in known_parts %}
           <option value="{{ part }}">
       {% endfor %}
    </datalist>

    <datalist id="sku-suggestions">
        </datalist>

    <datalist id="bin-suggestions">
        {% for bin in all_bins %}
            <option value="{{ bin }}">
        {% endfor %}
    </datalist>

<script>
    // Pass the map from Flask to JavaScript
    const acronymSkuMap = {{ acronym_sku_map|tojson }};

    // Get references to the elements
    const acronymSelect = document.getElementById('part_acronym'); // Changed back to Select for consistency with provided code, though input is better for adding new
    const skuDatalist = document.getElementById('sku-suggestions');
    const skuInput = document.getElementById('part_sku'); // Get the input field too

    // Function to update the SKU datalist
    function updateSkuSuggestions() {
        const selectedAcronym = acronymSelect.value; // Read value from input/select
        const skus = acronymSkuMap[selectedAcronym] || []; // Get SKUs or empty list

        // Clear existing options
        skuDatalist.innerHTML = '';

        // Add new options based on the selected acronym
        skus.forEach(sku => {
            const option = document.createElement('option');
            option.value = sku;
            skuDatalist.appendChild(option);
        });

        // Optional: Clear the SKU input field when acronym changes
        // skuInput.value = '';
    }

    // Add event listener to the acronym input/select
    acronymSelect.addEventListener('change', updateSkuSuggestions); // Use 'change' or 'input' depending on element type
    acronymSelect.addEventListener('input', updateSkuSuggestions); // Added input listener too for text input case

    // Optional: Call once on page load if you want to initialize based on a default acronym (if any)
    // document.addEventListener('DOMContentLoaded', updateSkuSuggestions);

</script>
{% endblock %}